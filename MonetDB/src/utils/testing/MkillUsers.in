#!@BASH@

PATH=/usr/bin:/bin:/usr/sbin:/sbin:$PATH

if      [ "$1" =       -l   ] ; then  LOCKFILE="$2"      ; shift ; shift
  elif  [ "$1" != "${1#-l}" ] ; then  LOCKFILE="${1#-l}" ; shift 
  else                                LOCKFILE="$$"
fi
LOCKFILE=/tmp/.${0##*/}.$LOCKFILE

files="`ls -d $* 2>/dev/null`"

if [ ! "$files" ] ; then  exit 0 ; fi

touch $LOCKFILE

function  LOG1  () { prompt="\n# `date +%H:%M:%S` >  " ; echo -en "$prompt$prompt$*$prompt\n\n" ; }
function  LOG2  () {  LOG1 $* ; LOG1 $* >&2 ; }
function  LOG2x () {  LOG2 $* ; "$@" ; }

case `uname` in
  Linux)
	pids1="`fuser $files | cut -d: -f2- | sed 's|[a-z]||g'`"
	PS="ps -f $pids1"
	FUSER="fuser -v"
	;;
  IRIX|IRIX64)
  	pids0="`fuser -q $files`"
  	pids1="`echo $pids0 | sed 's|,| |g'`"
	PS="ps -fp $pids0"
	FUSER="fuser"
	;;
  SunOS)
	pids1="`fuser $files 2>/dev/null`"
	pids0="`echo $pids1 | sed 's| |,|g'`"
	PS="ps -fp $pids0"
	FUSER="fuser"
	;;
# CYGWIN32_NT)
#	;;
esac

if [ "$pids1" ] ; then
	pids2="(`echo $pids1 | sed 's/ /|/g'`)"
	LOG2x	$PS
	LOG2x	$FUSER   $files
	LOG2x	fuser -k $files
	sleep 4
	if [ "`( ps -ef | egrep -w "$pids2" | egrep -v egrep ) 2>/dev/null`" ] ; then
		LOG2x	kill -9 $pids1
	fi
fi

rm -f $LOCKFILE
