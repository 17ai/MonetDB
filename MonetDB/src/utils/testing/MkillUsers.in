#!/bin/sh

PATH=/usr/bin:/bin:/usr/sbin:/sbin:$PATH

THISPATH=${0%/*}
THISFILE=${0##*/}
CHILD=$$
PARENT=""
LOCKFILE="$$"
while [ "${1#-}" != "$1" ] ; do
  if      [ "$1" =       -l   ] ; then  LOCKFILE="$2"      ; shift ; shift
    elif  [ "$1" != "${1#-l}" ] ; then  LOCKFILE="${1#-l}" ; shift 
    elif  [ "$1" =       -p   ] ; then  PARENT="$2"        ; shift ; shift
    elif  [ "$1" != "${1#-p}" ] ; then  PARENT="${1#-l}"   ; shift 
  fi
done
LOCKFILE=/tmp/.${0##*/}.$LOCKFILE

files="`ls -d $* 2>/dev/null`"

if [ ! "$files" ] ; then  exit 0 ; fi

touch $LOCKFILE

function  LOG1  () { prompt="\n# `date +%H:%M:%S` >  " ; echo -en "$prompt$prompt$*$prompt\n\n" ; }
function  LOG2  () {  LOG1 $* ; LOG1 $* >&2 ; }
function  LOG2x () {  LOG2 $* ; "$@" ; }

cpids=""
if [ "$PARENT" ] ; then
  cpids="`ps -ef | egrep '^ *[a-zA-Z0-9_]+ +[0-9]+ +'"$PARENT"' ' | egrep -v '^ *[a-zA-Z0-9_]+ +'"$CHILD"' +[0-9]+ ' | sort +4.0 | awk '{printf "%s ",$2}' | sed 's|  *$||'`"
  if [ "$cpids" ] ; then
	cpids="$cpids "
  fi
fi

files="$files `ls $THISPATH/* | egrep -v '/(M[a-z]*\.py(|\.bat)|'"$THISFILE"')$'`"

case `uname` in
  Linux)
	pids1="$cpids`fuser $files | cut -d: -f2- | sed 's|[a-z]||g'`"
	PS="ps -f $pids1"
	FUSER="fuser -v"
	;;
  IRIX|IRIX64)
  	pids0="`echo $cpids | sed 's| |,|g'``fuser -q $files`"
  	pids1="`echo $pids0 | sed 's|,| |g'`"
	PS="ps -fp $pids0"
	FUSER="fuser"
	;;
  SunOS)
	pids1="$cpids`fuser $files 2>/dev/null`"
	pids0="`echo $pids1 | sed 's| |,|g'`"
	PS="ps -fp $pids0"
	FUSER="fuser"
	;;
# CYGWIN32_NT)
#	;;
esac

if [ "$pids1" ] ; then
	pids2="(`echo $pids1 | sed 's/ /|/g'`)"
	LOG2x	$PS
	LOG2x	$FUSER   $files
	LOG2x	fuser -k $files
	if [ "$cpids" ] ; then
		sleep 3
		LOG2x   kill $cpids
	fi
	sleep 4
	if [ "`( ps -ef | egrep -w "$pids2" | egrep -v egrep ) 2>/dev/null`" ] ; then
		LOG2x	kill -9 $pids1
	fi
fi

rm -f $LOCKFILE
